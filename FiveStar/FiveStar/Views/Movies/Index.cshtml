@model FiveStars.Models.MovieFilterViewModel

@{
    ViewBag.Title = "Movies";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="movies-page container">

    <!-- ÜST BAŞLIK + FİLTRELER -->
    <div class="movies-header-row">
        <h1 class="movies-title">MOVIES</h1>

        <form id="movies-filter-form"
              method="get"
              action="@Url.Action("Index", "Movies")"
              class="movies-filter-form">

            <!-- SEARCH -->
            <div class="movies-search-wrapper">
                <i class="fas fa-search movies-search-icon"></i>
                <input type="text"
                       name="searchTerm"
                       class="movies-search-input"
                       placeholder="Search movie..."
                       value="@Model.SearchTerm" />
            </div>

            <!-- GENRE -->
            <div class="movies-filter-group">
                <label for="genreSelect" class="movies-filter-label">GENRE</label>
                <select id="genreSelect"
                        name="selectedGenreId"
                        class="movies-filter-select">
                    <option value="">All</option>
                    @foreach (var g in Model.Genres)
                    {
                        <option value="@g.GenreID"
                                @(Model.SelectedGenreId == g.GenreID ? "selected" : "")>
                            @g.Name
                        </option>
                    }
                </select>
            </div>

            <!-- CINEMA -->
            <div class="movies-filter-group">
                <label for="cinemaSelect" class="movies-filter-label">CINEMA</label>
                <select id="cinemaSelect"
                        name="selectedCinemaId"
                        class="movies-filter-select">
                    <option value="">All</option>
                    @foreach (var c in Model.Cinemas)
                    {
                        <option value="@c.CinemaID"
                                @(Model.SelectedCinemaId == c.CinemaID ? "selected" : "")>
                            @c.CinemaName
                        </option>
                    }
                </select>
            </div>

        </form>
    </div>

    <!-- FİLM GRIDİ -->

    <div id="moviesContainer">
        @Html.Partial("_MoviesGrid", Model.Movies)
    </div>


</div>

@section Scripts {
    <script>
  (function () {
    var $form  = $("#movies-filter-form");
    var $search = $("input[name='searchTerm']");
    var $genre  = $("#genreSelect");
    var $cinema = $("#cinemaSelect");
    var t = null;

    function loadMovies() {
      $.ajax({
        url: "@Url.Action("Filter", "Movies")",
        type: "GET",
        data: {
          searchTerm: $search.val(),
          selectedGenreId: $genre.val(),
          selectedCinemaId: $cinema.val()
        },
        success: function (html) {
          $("#moviesContainer").html(html);
        },
        error: function (xhr) {
          console.log("Filter error:", xhr.status, xhr.responseText);
        }
      });
    }

    // form submit olursa sayfayı yenileme, AJAX yap
    $form.on("submit", function (e) {
      e.preventDefault();
      loadMovies();
    });

    $genre.on("change", loadMovies);
    $cinema.on("change", loadMovies);

    $search.on("input", function () {
      clearTimeout(t);
      t = setTimeout(loadMovies, 300);
    });
  })();
    </script>
}
