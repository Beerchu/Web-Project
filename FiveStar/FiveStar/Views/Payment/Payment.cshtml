@model FiveStars.Models.PaymentViewModel
@{
    ViewBag.Title = "Payment Confirmation";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Temel Stil Düzeltmeleri */
    .payment-container {
        max-width: 1200px;
        margin: 50px auto;
        color: #E0E0E0;
        background-color: #1A1A1A;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .booking-details-box {
        background-color: #282828;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .summary-box {
        background-color: #282828;
        padding: 25px;
        border-radius: 8px;
        border: 1px solid #3A3A3A;
        margin-top: 30px;
    }

    .final-total {
        color: #4CAF50;
        font-size: 2em;
        font-weight: bold;
    }

    .discount-amount {
        color: #FF5252;
        font-weight: bold;
    }

    .btn-confirm {
        background-color: #E50914;
        border: none;
        font-size: 1.2em;
        padding: 15px 0;
        transition: background-color 0.3s;
    }

        .btn-confirm:hover {
            background-color: #B20710;
            color: white;
        }

    .form-control {
        background-color: #3A3A3A;
        color: #E0E0E0;
        border: 1px solid #555;
    }

        .form-control:focus {
            background-color: #3A3A3A;
            border-color: #E50914;
            box-shadow: 0 0 0 0.2rem rgba(229, 9, 20, 0.25);
        }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="payment-container">
    <h1 class="mb-5" style="color: white;">Payment Confirmation</h1>

    @using (Html.BeginForm("ConfirmPayment", "Payment", FormMethod.Post, new { id = "payment-form" }))
    {
        @Html.AntiForgeryToken()

        @Html.HiddenFor(m => m.OrderID)
        @Html.HiddenFor(m => m.SelectedCampaignID)

        @* --- 1. BOOKING DETAILS --- *@
        <div class="booking-details-box">
            <h4>Booking Details</h4>

            @if (Model.SelectedSeats != null && Model.SelectedSeats.Any())
            {
                <p>
                    <strong>Selected Seats:</strong>
                    <span style="font-size: 1.1em;">@string.Join(", ", Model.SelectedSeats)</span>
                </p>
            }
            <p>
                <strong>Base Total (Undiscounted):</strong>
                <span id="base-total" style="font-size: 1.1em; font-weight: bold;">@Model.BaseTotal.ToString("C")</span>
            </p>
        </div>

        @* --- 2. CAMPAIGN SELECTION --- *@
        <div class="form-group mb-5">
            <label for="campaign-dropdown">Available Campaigns:</label>
            @if (Model.AvailableCampaigns != null)
            {
                @Html.DropDownListFor(m => m.SelectedCampaignID,
                                         new SelectList(Model.AvailableCampaigns, "CampaignID", "Title", Model.SelectedCampaignID),
                                         "Select a Campaign",
                                         new { @class = "form-control", id = "campaign-dropdown" })
            }
            else
            {
                <p class="form-control-static" style="color: #FFD700;">No active campaigns available.</p>
            }
            @Html.ValidationMessageFor(m => m.SelectedCampaignID, "", new { @class = "text-danger" })
        </div>

        <hr style="border-color: #3A3A3A;" />

        @* --- 3. PAYMENT SUMMARY --- *@
        <div class="summary-box">
            <h4>Payment Summary</h4>
            <p>
                Discount Applied:
                <span id="discount-amount" class="discount-amount">@Model.DiscountAmount.ToString("C")</span>
            </p>
            <h3 class="mt-3">
                Final Total Payable:
                <span id="final-total" class="final-total">@Model.FinalTotal.ToString("C")</span>
            </h3>
        </div>

        @* --- 4. CREDIT CARD INFO (Simülasyon) --- *@
        <div class="my-4 p-3 bg-dark" style="border-radius: 5px;">
            <h5 style="color: #bbb;">Credit Card Information (Simulation)</h5>
            <p style="font-size: 0.9em; color: #999;">
                By clicking 'Confirm Payment', the Controller will assume the payment is successful.
            </p>
        </div>

        @* --- 5. SUBMIT BUTTON --- *@
        <div class="mt-4">
            <button type="submit" class="btn btn-lg btn-confirm w-100">
                CONFIRM PAYMENT AND ISSUE TICKET
            </button>
        </div>

        @Html.ValidationSummary(true, "", new { @class = "text-danger mt-3" })
    }
</div>

@* ========================================================================= *@
@* JAVASCRIPT / AJAX FUNCTIONALITY *@
@* ========================================================================= *@
<script>
    $(document).ready(function () {

        // Event triggered when Campaign Dropdown changes
        $('#campaign-dropdown').change(function () {
            var selectedCampaignId = $(this).val();
            // Send 0 if 'Select a Campaign' is chosen (empty string)
            var campaignIdToSend = selectedCampaignId || 0;
            var orderId = $('#OrderID').val();

            // AJAX call to recalculate price
            $.ajax({
                url: '@Url.Action("RecalculatePrice", "Payment")',
                type: 'POST',
                data: {
                    orderId: orderId,
                    campaignId: campaignIdToSend
                },
                success: function (response) {
                    if (response.success) {
                        // BAÞARILI DURUM: Controller'dan gelen güncel fiyatlarý DOM'a yaz
                        $('#discount-amount').text(response.discount);
                        $('#final-total').text(response.finalTotal);

                        // Hidden inputu güncelle
                        $('#SelectedCampaignID').val(response.selectedCampaignId);
                    } else {
                        // HATA DURUMU: (Kampanya Koþullarý Saðlanmadý)

                        // 1. Uyarý mesajýný göster
                        alert("Campaign cannot be applied: " + response.message);

                        // 2. Dropdown'ý 'Select a Campaign' seçeneðine geri getir
                        $('#campaign-dropdown').val('');

                        // 3. Ýndirim miktarýný sýfýrla ve Final Total'i Base Total'e geri döndür
                        // response.finalTotal, RecalculatePrice metodunda Base Total olarak geri gönderilmiþti.
                        $('#discount-amount').text(response.discount); // Bu 0.00 TL/USD olmalý
                        $('#final-total').text(response.finalTotal);

                        // 4. Gizli inputu temizle
                        $('#SelectedCampaignID').val('');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Ajax Error:", status, error);
                    alert("An unexpected server communication error occurred. Check the console for details.");
                }
            });
        });
    });
</script>