@model FiveStars.Models.SeatSelectionViewModel

@{
    ViewBag.Title = "Select Seats - " + Model.MovieTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="movie-detail-page container" style="max-width: 1400px; padding: 20px;">

    <h1 class="movie-detail-title" style="margin-bottom: 5px;">
        Select Seats for @Model.MovieTitle
    </h1>
    <p style="color: #bbb; font-size: 14px; margin-bottom: 25px;">
        @Model.CinemaName - @Model.StartTime.ToString("dd MMMM yyyy HH:mm") (@Model.ScreenType)
    </p>

    @using (Html.BeginForm("CreateOrderAndRedirectToPayment", "Tickets", FormMethod.Post, new { id = "seat-selection-form" }))
    {
        @Html.AntiForgeryToken()

        <input type="hidden" name="ShowingID" value="@Model.SessionTimeID" />
        <input type="hidden" id="BaseTotal" name="BaseTotal" value="0.00" />

        <div id="hidden-inputs-container">
        </div>

        <div class="seating-area">
            <div class="screen-area">
                <div class="screen">SCREEN</div>
                <p class="screen-caption">All eyes this way please!</p>
            </div>

            @foreach (var row in Model.SeatingPlan)
            {
                <div class="seat-row" data-row="@row.RowName">
                    <span class="row-label">@row.RowName</span>
                    @foreach (var seat in row.Seats)
                    {
                        if (seat == null)
                        {
                            <div class="seat-spacer"></div>
                        }
                        else
                        {
                            var seatClass = "seat-item seat-" + seat.Status.ToLower();
                            var seatTypeClass = "seat-type-" + seat.Type.ToLower();

                            // Koltuğun tam numarasını data-seat-name olarak ekle. (Örn: A5)
                            string fullSeatName = row.RowName + seat.SeatNumber;

                            <button type="button"
                                    class="@(seatClass) @(seatTypeClass)"
                                    data-id="@seat.SeatID"
                                    data-status="@seat.Status"
                                    data-price="@(Model.TicketPrice + seat.ExtraPrice)"
                                    data-seat-name="@fullSeatName"
                                    @(seat.Status == "Sold" ? "disabled" : "")
                                    onclick="toggleSeatSelection(this)">

                                @seat.SeatNumber

                            </button>
                        }
                    }
                    <span class="row-label">@row.RowName</span>
                </div>
            }
        </div>

        <div class="checkout-summary">
            <span id="selected-seats-info">Seats: 0</span> |
            <span id="total-price">Total: 0.00 TL</span>

            <button type="submit" class="movie-detail-btn-primary" id="checkout-btn" disabled style="opacity: 0.5;">
                Proceed to Payment
            </button>
        </div>
    }
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const TICKET_PRICE = parseFloat('@Model.TicketPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)');
        const hiddenInputsContainer = document.getElementById('hidden-inputs-container');

        function toggleSeatSelection(button) {
            if (button.dataset.status === "Sold") {
                return;
            }

            let currentStatus = button.dataset.status;
            let newStatus;

            if (currentStatus === "Available") {
                newStatus = "Selected";
                button.classList.remove('seat-available');
                button.classList.add('seat-selected');
            } else if (currentStatus === "Selected") {
                newStatus = "Available";
                button.classList.remove('seat-selected');
                button.classList.add('seat-available');
            } else {
                return;
            }

            button.dataset.status = newStatus;
            updateSummary();
        }

        function updateSummary() {
            let selectedSeats = document.querySelectorAll('.seat-item[data-status="Selected"]');
            let totalTickets = selectedSeats.length;
            let totalPrice = 0;
            let selectedSeatNumbers = [];

            hiddenInputsContainer.innerHTML = '';

            selectedSeats.forEach(seat => {
                let price = parseFloat(seat.dataset.price);
                totalPrice += price;

                const fullSeatName = seat.dataset.seatName;
                selectedSeatNumbers.push(fullSeatName);

                // --- Gizli Inputları Dinamik Olarak Oluşturma ---

                // 1. SelectedSeatIDs
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'SelectedSeatIDs';
                idInput.value = seat.dataset.id;
                hiddenInputsContainer.appendChild(idInput);

                // 2. SelectedSeatNumbers
                const numberInput = document.createElement('input');
                numberInput.type = 'hidden';
                numberInput.name = 'SelectedSeatNumbers';
                numberInput.value = fullSeatName;
                hiddenInputsContainer.appendChild(numberInput);
            });

            // Görüntüleme alanlarını güncelle
            document.getElementById('selected-seats-info').textContent = `Seats: ${totalTickets} (${selectedSeatNumbers.join(', ')})`;

            const formattedPrice = totalPrice.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
            document.getElementById('total-price').textContent = `Total: ${formattedPrice}`;

            document.getElementById('BaseTotal').value = totalPrice.toFixed(2);

            const checkoutBtn = document.getElementById('checkout-btn');

            if (totalTickets > 0) {
                checkoutBtn.removeAttribute('disabled');
                checkoutBtn.style.opacity = 1;
            } else {
                checkoutBtn.setAttribute('disabled', 'disabled');
                checkoutBtn.style.opacity = 0.5;
            }
        }

        document.addEventListener('DOMContentLoaded', updateSummary);
    </script>
}