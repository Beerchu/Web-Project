@model FiveStars.Models.SeatSelectionViewModel

@{
    ViewBag.Title = "Select Seats - " + Model.MovieTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="movie-detail-page container" style="max-width: 1400px; padding: 20px;">

    <h1 class="movie-detail-title" style="margin-bottom: 5px;">
        Select Seats for @Model.MovieTitle
    </h1>
    <p style="color: #bbb; font-size: 14px; margin-bottom: 25px;">
        @Model.CinemaName - @Model.StartTime.ToString("dd MMMM yyyy HH:mm") (@Model.ScreenType)
    </p>

    @using (Html.BeginForm("CreateOrderAndRedirectToPayment", "Tickets", FormMethod.Post, new { id = "seat-selection-form" }))
    {
        // 👇 HttpAntiForgeryException HATASINI ÇÖZEN GÜVENLİK JETONU 👇
        @Html.AntiForgeryToken()

        // GİZLİ ALANLAR: Controller'a göndereceğimiz zorunlu veriler.
        <input type="hidden" name="ShowingID" value="@Model.SessionTimeID" />
        <input type="hidden" id="BaseTotal" name="BaseTotal" value="0.00" />

        <div id="hidden-inputs-container">
        </div>

        <div class="seating-area">
            <div class="screen-area">
                <div class="screen">SCREEN</div>
                <p class="screen-caption">All eyes this way please!</p>
            </div>

            @foreach (var row in Model.SeatingPlan)
            {
            <div class="seat-row" data-row="@row.RowName">
                <span class="row-label">@row.RowName</span>
                @foreach (var seat in row.Seats.Where(s => s != null)) // Sadece gerçek koltukları döngüye al
                {
                    // Var olan koltuk butonu kodu buraya gelir.
                    var seatClass = "seat-item seat-" + seat.Status.ToLower();
                    var seatTypeClass = "seat-type-" + seat.Type.ToLower();

                    <button type="button"
                            class="@(seatClass) @(seatTypeClass)"
                            data-id="@seat.SeatID"
                            data-status="@seat.Status"
                            data-price="@(Model.TicketPrice + seat.ExtraPrice)"
                            @(seat.Status == "Sold" ? "disabled" : "")
                            onclick="toggleSeatSelection(this)">
                        @seat.SeatNumber.Substring(1)
                    </button>
                }
                <span class="row-label">@row.RowName</span>
            </div>
            }
        </div>

        <div class="checkout-summary">
            <span id="selected-seats-info">Seats: 0</span> |
            <span id="total-price">Total: 0.00 TL</span>

            <button type="submit" class="movie-detail-btn-primary" id="checkout-btn" disabled style="opacity: 0.5;">
                Proceed to Payment
            </button>
        </div>
    }
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // KÜLTÜR AYARINDAN BAĞIMSIZ DOĞRU FİYATI ALMAK İÇİN
        const TICKET_PRICE = parseFloat('@Model.TicketPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)');
        const hiddenInputsContainer = document.getElementById('hidden-inputs-container');

        // Koltuk seçim durumunu değiştirir
        function toggleSeatSelection(button) {
            if (button.dataset.status === "Sold") {
                return;
            }

            let currentStatus = button.dataset.status;
            let newStatus;

            if (currentStatus === "Available") {
                newStatus = "Selected";
                button.classList.remove('seat-available');
                button.classList.add('seat-selected');
            } else if (currentStatus === "Selected") {
                newStatus = "Available";
                button.classList.remove('seat-selected');
                button.classList.add('seat-available');
            } else {
                return;
            }

            button.dataset.status = newStatus;
            updateSummary();
        }

        // Özeti ve en önemlisi gizli form inputlarını günceller
        function updateSummary() {
            let selectedSeats = document.querySelectorAll('.seat-item[data-status="Selected"]');
            let totalTickets = selectedSeats.length;
            let totalPrice = 0;
            let selectedSeatNumbers = [];

            // Gizli inputları temizle
            hiddenInputsContainer.innerHTML = '';

            selectedSeats.forEach(seat => {
                let price = parseFloat(seat.dataset.price);
                totalPrice += price;

                // Seçilen koltuk Numaralarını topla (Görüntüleme için)
                selectedSeatNumbers.push(seat.dataset.name);

                // --- Gizli Inputları Dinamik Olarak Oluşturma ---

                // 1. SelectedSeatIDs (Controller'da List<int> yakalamak için)
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'SelectedSeatIDs';
                idInput.value = seat.dataset.id;
                hiddenInputsContainer.appendChild(idInput);

                // 2. SelectedSeatNumbers (Controller'da List<string> yakalamak için)
                const numberInput = document.createElement('input');
                numberInput.type = 'hidden';
                numberInput.name = 'SelectedSeatNumbers';
                numberInput.value = seat.dataset.name;
                hiddenInputsContainer.appendChild(numberInput);
            });

            // Görüntüleme alanlarını güncelle
            document.getElementById('selected-seats-info').textContent = `Seats: ${totalTickets} (${selectedSeatNumbers.join(', ')})`;

            // Türk Lirası formatında gösterim
            const formattedPrice = totalPrice.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
            document.getElementById('total-price').textContent = `Total: ${formattedPrice}`;

            // Base Total gizli inputunu güncelle (Controller'ın beklediği nokta formatında)
            document.getElementById('BaseTotal').value = totalPrice.toFixed(2);


            const checkoutBtn = document.getElementById('checkout-btn');

            if (totalTickets > 0) {
                checkoutBtn.removeAttribute('disabled');
                checkoutBtn.style.opacity = 1;
            } else {
                checkoutBtn.setAttribute('disabled', 'disabled');
                checkoutBtn.style.opacity = 0.5;
            }
        }

        document.addEventListener('DOMContentLoaded', updateSummary);
    </script>
}